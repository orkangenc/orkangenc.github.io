<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sentinity</title>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="../../css/all.css">


    <!-- --------- Owl-Carousel ------------------->
    <link rel="stylesheet" href="../../css/owl.carousel.min.css">
    <link rel="stylesheet" href="../../css/owl.theme.default.min.css">

    <!-- ------------ AOS Library ------------------------- -->
    <link rel="stylesheet" href="./css/aos.css">

    <!-- Custom Style   -->
    <link rel="stylesheet" href="../../css/Style.css">
    <link rel="shortcut icon" href="../../assets/favicon.png" type="image/png" />
</head>

<style type="text/css">
    code {
        padding: 3px 6px
    }
    
    .pi {
        font-weight: bold;
        color: black;
    }
    
    code,
    pre {
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        border-radius: 2px;
        background: rgba(233, 235, 239, .5);
    }
    
    code:focus,
    pre:focus {
        outline: none
    }
    
    pre {
        overflow: auto;
        padding: 15px 20px
    }
    
    pre code {
        padding: 0;
        background: transparent
    }
    
    .wp-block-code code {
        white-space: pre-wrap;
        overflow-wrap: break-word
    }
</style>

<body>

    <!-- ----------------------------  Navigation ---------------------------------------------- -->

    <nav class="nav">
        <div class="nav-menu flex-row">
            <div class="nav-brand">
                <a href="/index.html" class="text-gray">Sentinity</a>
            </div>
            <div class="toggle-collapse">
                <div class="toggle-icons">
                    <i class="fas fa-bars"></i>
                </div>
            </div>
            <div>
                <ul class="nav-items">
                    <li class="nav-link">
                        <a href="/index.html">Home</a>
                    </li>
                    <!--
                    <li class="nav-link">
                        <a href="#">Category</a>
                    </li>
                    <li class="nav-link">
                        <a href="#">Archive</a>
                    </li>
                    <li class="nav-link">
                        <a href="#">Pages</a>
                    </li>
                    <li class="nav-link">
                        <a href="#">Contact Us</a>
                    </li>
                    -->
                </ul>
            </div>
            <div class="social text-gray">
                <a href=""><i class="fab fa-facebook-f"></i></a>
                <a href=""><i class="fab fa-instagram"></i></a>
                <a href=""><i class="fab fa-twitter"></i></a>
                <a href=""><i class="fab fa-youtube"></i></a>
            </div>
        </div>

    </nav>

    <!-- ------------x---------------  Navigation --------------------------x------------------- -->

    <!----------------------------- Main Site Section ------------------------------>

    <main>

        <!------------------------ Site Title ---------------------->


        <!------------x----------- Site Title ----------x----------->

        <!-- --------------------- Blog Carousel ----------------- -->



        <!-- ----------x---------- Blog Carousel --------x-------- -->

        <!-- ---------------------- Site Content -------------------------->

        <section class="container">
            <div class="site-content">

                <!-- #######  THIS IS A COMMENT - Visible only in the source editor #########-->
                <div class="news-content news-post-main-content">
                    <h2><u>11gR2 RAC to RAC Data Guard Configuration</u></h2>

                    <p>The initial setup is not much different between RAC-RAC and RAC-Single instance data guard, in a way setting up the data guard is same with some additional setps at the end of setup in the way of bringing the Standby database under
                        the control of clusterware. The primary RAC environment consists of two nodes, hostname orcliprd1 and orcliprd2. The primary database name is optimus and two instances are optimus1 (running on orcliprd1 node) and optimus2 (on orcliprd2).</p>
                    <p></p>
                    <p>The standby RAC environment also consists of two nodes (symmetrical data guard) hostname orclis1 and orclis2. The standby database will be named prime and the corresponding instances will be prime1 (on orclis1) and prime2 (on orclis2).</p>
                    <p></p>
                    <p>The software version is 11.2.0.2 on both primary and standby (both grid home and oracle home). Primary site has database created and standby site has grid infrastructure and oracle home software installed.</p>
                    <p></p>
                    <p><u>From Data Guard Concepts and Administration</u></p>
                    <p></p>
                    <p>New 11.2 Features Common to Redo Apply and SQL Apply As of Oracle Database 11g Release 2 (11.2.0.2), Oracle Data Guard is fully integrated with Oracle Real Application Clusters One Node (Oracle RAC One Node). A Data Guard configuration
                        can now consist of a primary database and up to 30 standby databases. The FAL_CLIENT database initialization parameter is no longer required. The default archive destination used by the Oracle Automatic Storage Management (Oracle
                        ASM) feature and the fast recovery area feature has changed from LOG_ARCHIVE_DEST_10 to LOG_ARCHIVE_DEST_1. Redo transport compression is no longer limited to compressing redo data only when a redo gap is being resolved. When compression
                        is enabled for a destination, all redo data sent to that destination is compressed.</p>
                    <p>The new ALTER SYSTEM FLUSH REDO SQL statement can be used at failover time to flush unsent redo from a mounted primary database to a standby database, thereby allowing a zero data loss failover to be performed even if the primary database
                        is not running in a zero data loss data protection mode. See Section 8.2.2 for more information.</p>
                    <p></p>
                    <p><u>New 11.2 Features Specific to Redo Apply</u></p>
                    <p>You can configure apply lag tolerance in a real-time query environment by using the new STANDBY_MAX_DATA_DELAY parameter. You can use the new ALTER SESSION SYNC WITH PRIMARY SQL statement to ensure that a suitably configured physical
                        standby database is synchronized with the primary database as of the time the statement is issued. The V$DATAGUARD_STATS view has been enhanced to a greater degree of accuracy in many of its columns, including apply lag and transport
                        lag. You can view a histogram of apply lag values on the physical standby. To do so, query the new V$STANDBY_EVENT_HISTOGRAM view. A corrupted data block in a primary database can be automatically replaced with an uncorrupted copy
                        of that block from a physical standby database that is operating in real-time query mode. A corrupted block in a physical standby database can also be automatically replaced with an uncorrupted copy of the block from the primary
                        database.
                    </p>
                    <p></p>
                    <pi>
                        1. On the standby ASM instances would have been created when grid infrastructure was installed but not the ASM diskgroups. Using asmca create diskgroup on the standby ASM instances. In this case both primary and standby ASM diskgroups are named +DATA
                        and +FRA
                    </pi>
                    <p></p>
                    <pi>
                        2. Create following directory structures in all standby nodes
                    </pi>
                    <pre class="wp-block-code"><code>
$ cd $ORACLE_BASE
$ mkdir admin
$ cd admin/
$ mkdir prime
$ cd prime/
$ mkdir adump dpdump hdump pfile</code></pre>
                    <p></p>

                    <pi>3. It is assumed primary db is in archivelog mode if not put the db in archive log mode. This is required since duplication is done using active database.</pi>
                    <p></p>
                    <pi>4. Enable force logging on the primary database</pi>
                    <pre class="wp-block-code"><code>SQL> alter database force logging;</code></pre>
                    <p></p>
                    <pi>5. Create standby log files for each thread on primary db. These should be same size as the online redo log files</pi>
                    <p></p>
                    <pre class="wp-block-code"><code>SQL> alter database add standby logfile thread 1 size 52428800;</code></pre>
                    <p>or</p>
                    <pre class="wp-block-code"><code>SQL> alter database add standby logfile thread 1;
SQL> alter database add standby logfile thread 2;
                    </code></pre>

                    <p>There should be at least one more redo log group per thread than the online redo logs.</p>
                    <p></p>

                    <pi>6. On both primary and standby add static listener entries in $GRID_HOME($CRS_HOME)/network/admin/listener.ora. If scan listener is used for connections create static listener for those as well. </pi>
                    <p>One key difference is both in 10gR2 and 11gR1 the static listener and default listeners have hostname appended to the end but on 11gR2 this is not the case. Find out the available listeners with</p>
                    <pre class="wp-block-code"><code>
$ srvctl config listener
Name: LISTENER
Network: 1, Owner: oracle
Home:
End points: TCP:3000

$ srvctl config scan_listener
SCAN Listener LISTENER_SCAN1 exists. Port: TCP:3000
</code></pre>

                    <p>and create the static listeners for default listener as well as the scan listener. For standby on orclis1</p>
                    <pre class="wp-block-code"><code>
$ more listener.ora
LISTENER=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER))))
# line added by Agent
LISTENER_SCAN1=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_SCAN1))))
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER_SCAN1=ON
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON 
# line added by Agent

SID_LIST_LISTENER =
 (SID_LIST =
   (SID_DESC =
     (GLOBAL_DBNAME = prime)
     (SID_NAME = prime1)
     (ORACLE_HOME = /oracle/product/11.2.0.3/db)
   )
 )

SID_LIST_LISTENER_SCAN1 =
 (SID_LIST =
   (SID_DESC =
   (GLOBAL_DBNAME = prime)
   (SID_NAME = prime1)
   (ORACLE_HOME = /oracle/product/11.2.0.3/db)
   )
 )

on orclis2

$ more listener.ora
LISTENER_SCAN1=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_SCAN1))))
# line added by Agent
LISTENER=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER))))
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON 
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER_SCAN1=ON 
# line added by Agent

SID_LIST_LISTENER =
(SID_LIST =
(SID_DESC =
(GLOBAL_DBNAME = prime)
(SID_NAME = prime2)
(ORACLE_HOME = /oracle/product/11.2.0.3/db)
)
)

SID_LIST_LISTENER_SCAN1 =
(SID_LIST =
(SID_DESC =
(GLOBAL_DBNAME = prime)
(SID_NAME = prime2)
(ORACLE_HOME = /oracle/product/11.2.0.3/db)
)
</code></pre>
                    <p>In 11gR2 there's another file in $ORACLE_HOME/network/admin folder called endpoints_listener.ora. This is there for backward compatibility with pre-11.2 databases. More on metalink note 11.2 Scan and Node TNS Listener Setup Examples
                        [ID 1070607.1] Stop and start the listeners on standby</p>
                    <pre class="wp-block-code"><code>
$ srvctl stop listener -n hostname
$ srvctl start listener -n hostname

$ srvctl stop scan_listener
$ srvctl start scan_listener

</code></pre>
                    <p>After this stop and start of listeners doing a listener status listener would show the statically registered instance and service as below</p>
                    <pre class="wp-block-code"><code>
Service "prime" has 1 instance(s).
Instance "prime1", status UNKNOWN, has 1 handler(s) for this service...
The command completed successfully
</code></pre>
                    <p>Do the same for primary environment on orcliprd1</p>
                    <pre class="wp-block-code"><code>
$ more listener.ora
LISTENER=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER))))
# line added by Agent
LISTENER_SCAN1=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_SCAN1))))
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER_SCAN1=ON 
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON 
# line added by Agent

SID_LIST_LISTENER =
(SID_LIST =
(SID_DESC =
(GLOBAL_DBNAME = optimus)
(SID_NAME = optimus1)
(ORACLE_HOME = /oracle/product/11.2.0.3/db)
)
)

SID_LIST_LISTENER_SCAN1 =
(SID_LIST =
(SID_DESC =
(GLOBAL_DBNAME = optimus)
(SID_NAME = optimus1)
(ORACLE_HOME = /oracle/product/11.2.0.3/db)
)
)

on orcliprd2

$ more listener.ora
LISTENER_SCAN1=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER_SCAN1))))
# line added by Agent
LISTENER=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER))))
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON 
# line added by Agent
ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER_SCAN1=ON 
# line added by Agent

SID_LIST_LISTENER =
(SID_LIST =
(SID_DESC =
(GLOBAL_DBNAME = optimus)
(SID_NAME = optimus2)
(ORACLE_HOME = /oracle/product/11.2.0.3/db)
)
)

SID_LIST_LISTENER_SCAN1 =
(SID_LIST =
(SID_DESC =
(GLOBAL_DBNAME = optimus)
(SID_NAME = optimus2)
(ORACLE_HOME = /oracle/product/11.2.0.3/db)
)
)</code></pre>


                    <pi>7. Create TNS entries on both primary and standby. On all primary node's $ORACLE_HOME/network/admin</pi>
                    <pre class="wp-block-code"><code>

PRIMESCAN =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = prime-scan)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = prime)
)
)

PRIME =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = prime1-vip)(PORT = 3000))
(ADDRESS = (PROTOCOL = TCP)(HOST = prime2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = prime)
)
)

PRIME1 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = prime1-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = prime)
(INSTANCE_NAME = prime1)
)
)

PRIME2 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = prime2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = prime)
(INSTANCE_NAME = prime2)
)
)

OPTIMUS =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus1-vip)(PORT = 3000))
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = optimus)
)
)

OPTIMUS1 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus1-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = optimus)
(INSTANCE_NAME = optimus1)
)
)

OPTIMUS2 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = optimus)
(INSTANCE_NAME = optimus2)
)
)
</code></pre>
                    <p>On all standby node's $ORACLE_HOME/network/admin</p>
                    <pre class="wp-block-code"><code>
OPTIMUSSCAN =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = rac-scan)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = optimus)
)
)

OPTIMUS =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus1-vip)(PORT = 3000))
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = optimus)
)
)

OPTIMUS1 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus1-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = optimus)
(INSTANCE_NAME = optimus1)
)
)


OPTIMUS2 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = optimus2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = optimus)
(INSTANCE_NAME = optimus2)
)
)

PRIME =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = prime1-vip)(PORT = 3000))
(ADDRESS = (PROTOCOL = TCP)(HOST = prime2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = prime)
)
)

PRIME1 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = prime1-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = prime)
(INSTANCE_NAME = prime1)
)
)


PRIME2 =
(DESCRIPTION =
(ADDRESS = (PROTOCOL = TCP)(HOST = prime2-vip)(PORT = 3000))
(CONNECT_DATA =
(SERVER = DEDICATED)
(SERVICE_NAME = prime)
(INSTANCE_NAME = prime2)
)
)
</code></pre>

                    <pi>8. Before modifying initialization parameters create a pfile from the spfile on the primary db </pi>
                    <pre class="wp-block-code"><code>SQL> create pfile='/home/oracle/optimusinitpfile.ora' from spfile;</code></pre>
                    <p>If you are planning to duplicate over an existing (working) instance you can use the same pfile</p>
                    <pre class="wp-block-code"><code>SQL> create pfile='/home/oracle/pfileDir/admracinitpfile' from spfile;</code></pre>


                    <pi>9. Modify the initialization parameters on the primary db. </pi>

                    <p>Remote archive dest state is set to defer, enable it before running the standby duplication. LGWR with ASYNC and NOAFFIRM is used as the redo transport, this could be changed to suite the protection mode. Also FAL_CLIENT parameter
                        has been set to each instance. This could be set to OPTIMUS TNS entry which has all entries.</p>
                    <pre class="wp-block-code"><code>SQL> create pfile='/home/oracle/optimusinitpfile.ora' from spfile;
alter system set log_archive_max_processes=6 scope=both;
alter system set DB_FILE_NAME_CONVERT='+DATASSD/prime','+DATASSD/optimus','+DATASAS/prime','+DATASAS/optimus' scope=spfile;
alter system set log_FILE_NAME_CONVERT='+FRA/prime','+FRA/optimus','+DATASSD/prime','+DATASSD/optimus','+DATASAS/prime','+DATASAS/optimus' scope=spfile;</code></pre>

                    <p>To make these changes take effect it requires a database restart not an instance restart this is due to the fact that filename convert parameter must be same on all nodes. If an instance restart is done it will fail with the following
                        error on alert log</p>
                    <pre class="wp-block-code"><code>                       
NOTE: Loaded library: System
SUCCESS: diskgroup DATA was mounted
SUCCESS: diskgroup FRA was mounted
NOTE: dependency between database optimus and diskgroup resource
ora.DATA.dg is established
NOTE: dependency between database optimus and diskgroup resource
ora.FRA.dg is established
ORA-1105 signalled during: ALTER DATABASE MOUNT /* db agent *//*
{1:7917:278} */...
Fri Feb 18 14:49:17 2011
Shutting down instance (abort)
License high water mark = 1
USER (ospid: 9322): terminating the instance
Instance terminated by USER, pid = 9322
Fri Feb 18 14:49:18 2011
Instance shutdown complete
</code></pre>
                    <p>on the command shell</p>
                    <pre class="wp-block-code"><code>    
$ srvctl stop instance -d optimus -i optimus1
$ srvctl start instance -d optimus -i optimus1
PRCR-1013 : Failed to start resource ora.optimus.db
PRCR-1064 : Failed to start resource ora.optimus.db on node orcliprd1
CRS-5017: The resource action "ora.optimus.db start" encountered the following error:
ORA-01105: mount is incompatible with mounts by other instances
ORA-01677: standby file name convert parameters differ from other instance
CRS-2674: Start of 'ora.optimus.db' on 'orcliprd1' failed
</code></pre>
                    <p>If the dataguard traffic is only one way (don't plan to use current primary as a standby in the future, then filename convert parameters could be ommited and a instnace restart could be carried out), otherwise do a database restart
                        which means brining the system down.</p>
                    <p></p>

                    <pi>10. Another difference between 10gR2/11gR1 and 11gR2 is the local_listener and remote_listener parameters. According to Real Application Clusters Installation Guide During Oracle Database creation, the LOCAL_LISTENER parameter is automatically
                        configured to point to the local listener for the database. The Database Agent sets the LOCAL_LISTENER parameter to a connect descriptor that does not require a TNS alias.</pi>

                    <p>You can set a value manually for LOCAL_LISTENER. However, Oracle recommends that you leave the parameter unset so that the Database Agent can maintain it automatically. If you set LOCAL_LISTENER, then the Agent does not automatically
                        update this value. If you do not set LOCAL_LISTENER, then the Database Agent automatically keeps the database associated with the Grid home's node listener updated, even as the ports or IP of that listener are changed.</p>

                    <p>With Oracle Clusterware 11g release 2 and later, Database Configuration Agent (DBCA) no longer sets the LOCAL_LISTENER parameter. The Oracle Clusterware agent that starts the database sets the LOCAL_LISTENER parameter dynamically,
                        and it sets it to the actual value, not an alias. So listener_alias entries are no longer needed in the tnsnames.ora file. For the REMOTE_LISTENER parameter, Oracle lusterware uses the EZ connect syntax scanname:scanport, so no
                        entries are needed for the REMOTE_LISTENER parameter in the tnsnames.ora file.More on 11gR2 Grid Infrastructure Single Client Access Name (SCAN) Explained [ID 887522.1]</p>
                    <p></p>

                    <pi>11. On 11gr2 remote listener is set to scan identify the standby scan name with</pi>
                    <pre class="wp-block-code"><code> 
$ srvctl config scan
SCAN name: prime-scan, Network: 1/192.168.0.0/255.255.255.0/eth0
SCAN VIP name: scan1, IP: /racb-scan/192.168.0.92
</code></pre>
                    <p>This will be used later on.</p>

                    <pi>12. Copy the primary password file to standby nodes and rename accordingly. On orclis1 where instance prime1 will be running password file will be named orapwprime1 and on orclis2 orapwprime2.</pi>
                    <p></p>
                    <pre class="wp-block-code"><code> 
on orclprd1:
$ scp /oracle/product/11.2.0.3/db/dbs/orapwoptimus1 oracle@orclis1:/oracle/product/11.2.0.3
on orclprd2:
$ scp /oracle/product/11.2.0.3/db/dbs/orapwoptimus2 oracle@orclis2:/oracle/product/11.2.0.3/db/dbs/orapwprime2
                </code></pre>


                    <pi>13. Select one node (orclis1 in this case) on the standby cluster and create a pfile with db_name entry which will have the standby database name (not the instance name). Rename the pfile with the instance name.</pi>

                    <p>cat initprime1.ora</p>
                    <p>db_name=prime</p>

                    <pi>14. Start the instance in nomount mode</pi>
                    <pre class="wp-block-code"><code> 
export ORACLE_SID=prime1
SQL> startup nomount pfile='/home/oracle/pfileDir/primeinitpfile';  --you need to do this!!!

ORACLE instance started.

Total System Global Area 217157632 bytes
Fixed Size 2225064 bytes
Variable Size 159386712 bytes
Database Buffers  50331648 bytes
Redo Buffers 5214208 bytes
                    </code></pre>

                    <pi>15. On primary db enable the deferred log archive destination</pi>
                    <pre class="wp-block-code"><code> 
SQL> alter system set log_archive_dest_state_2='enable' SCOPE=both sid='*'; -->; for prime
SQL> alter system set log_archive_dest_state_3='enable' SCOPE=both sid='*'; --> for admrac
                </code></pre>

                    <pi>16. On one node in the primary rac (orclprd1 in this case) connect to primary instance (target) as well standby instance (using rman auxiliary connection)</pi>
                    <pre class="wp-block-code"><code>
rman target / auxiliary sys/******@prime1

Recovery Manager: Release 11.2.0.2.0 - Production on Fri Feb 18 15:12:39 2011

Copyright (c) 1982, 2009, Oracle and/or its affiliates. All rights reserved.

connected to target database: OPTIMUS (DBID=379668842)
connected to auxiliary database: PRIME (not mounted)
</code></pre>

                    <pi>17. Run the duplication command with</pi>
                    <pre class="wp-block-code"><code>
duplicate target database for standby from active database
spfile
parameter_value_convert 'optimus','prime','OPTIMUS','PRIME'
set db_unique_name='prime'
set db_file_name_convert='+DATASSD/optimus','+DATASSD/prime','+DATASAS/optimus','+DATASAS/prime'
set log_file_name_convert='+FRA/optimus','+FRA/prime','+DATASSD/optimus','+DATASSD/prime','+DATASAS/optimus','+DATASAS/prime'
set control_files='+DATASSD','+FRA'
set instance_number='1'
set remote_listener='prime-scan.takasdom.takasbank.com.tr:3000'
reset local_listener
set log_archive_dest_1='LOCATION=+FRA VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=prime'
set log_archive_dest_2='SERVICE=optimus SYNC AFFIRM NET_TIMEOUT=30 REOPEN=300 DB_UNIQUE_NAME=optimus VALID_FOR=(ALL_LOGFILES,PRIMARY_ROLE)'
set log_archive_dest_3='SERVICE=admrac ASYNC NOAFFIRM NET_TIMEOUT=30 REOPEN=300 DB_UNIQUE_NAME=admrac VALID_FOR=(ALL_LOGFILES,PRIMARY_ROLE)'
set log_archive_dest_state_2='DEFER'
</code></pre>
                    <p>Key parameters are data file and log file name converters as well as the parameter value converter which maps primary environment values to appropriate standby environment values. local_listener is reset as it is auto set by grid infrastructure.
                        remote_listener value is set the scan ip and port identified earlier.</p>
                    <pre class="wp-block-code"><code>
rman target / auxiliary sys/......@prime1

Recovery Manager: Release 11.2.0.2.0 - Production on Fri Feb 18 16:10:16 2011

Copyright (c) 1982, 2009, Oracle and/or its affiliates. All rights reserved.

connected to target database: OPTIMUS (DBID=379668842)
connected to auxiliary database: PRIME (not mounted)
</code></pre>

                    <pi>18. Delete the database files from ASM +DATA diskgroup using ASMCMD utility:</pi>
                    <pre class="wp-block-code"><code> 
asmcmd rm '+DATASSD/PRIME/CONTROLFILE/*'
asmcmd rm '+DATASAS/PRIME/DATAFILE/*'
asmcmd rm '+DATASSD/PRIME/DATAFILE/*'
asmcmd rm '+DATASSD/PRIME/ONLINELOG/*'
asmcmd rm '+DATASAS/PRIME/TEMPFILE/*'
asmcmd rm '+DATASSD/PRIME/PARAMETERFILE/*'

asmcmd rm '+DATASSD/ADMRAC/CONTROLFILE/*'
asmcmd rm '+DATASAS/ADMRAC/DATAFILE/*'
asmcmd rm '+DATASSD/ADMRAC/DATAFILE/*'
asmcmd rm '+DATASSD/ADMRAC/ONLINELOG/*'
asmcmd rm '+DATASAS/ADMRAC/TEMPFILE/*'
asmcmd rm '+DATASSD/ADMRAC/PARAMETERFILE/*'
</code></pre>



                    <pi>19. Delete the database files from ASM +FRA diskgroup using ASMCMD utility:</pi>
                    <pre class="wp-block-code"><code> 
asmcmd rm '+FRA/PRIME/CONTROLFILE/*'
asmcmd rm '+FRA/PRIME/BACKUPSET/*'
asmcmd rm '+FRA/PRIME/ONLINELOG/*'
asmcmd rm '+FRA/PRIME/FLASHBACK/*'

asmcmd rm '+FRA/ADMRAC/CONTROLFILE/*'
asmcmd rm '+FRA/ADMRAC/BACKUPSET/*'
asmcmd rm '+FRA/ADMRAC/ONLINELOG/*'
asmcmd rm '+FRA/ADMRAC/FLASHBACK/*'
                        </code></pre>

                    <p></p>
                    <p>On Standby Node A, rename any existing PFILE in $ORACLE_HOME/dbs (default location for database initialisation files)</p>
                    <pre class="wp-block-code"><code> 
mv $ORACLE_HOME/dbs/initprime1.ora $ORACLE_HOME/dbs/initprime1.bak
mv $ORACLE_HOME/dbs/initprime2.ora $ORACLE_HOME/dbs/initprime2.bak

mv $ORACLE_HOME/dbs/initadmrac1.ora $ORACLE_HOME/dbs/initadmrac1.bak
mv $ORACLE_HOME/dbs/initadmrac2.ora $ORACLE_HOME/dbs/initadmrac2.bak
</code></pre>
                    <p></p>
                    <pre class="wp-block-code"><code>                   
RMAN>
run
{
allocate channel a1 type disk ;
allocate channel a2 type disk;
allocate channel a3 type disk;
allocate channel a4 type disk;
allocate channel a5 type disk;
allocate channel a6 type disk;
allocate channel a7 type disk;
allocate channel a8 type disk;
allocate auxiliary channel stby1 type disk ;
allocate auxiliary channel stby2 type disk ;
allocate auxiliary channel stby3 type disk ;
allocate auxiliary channel stby4 type disk ;
allocate auxiliary channel stby5 type disk ;
allocate auxiliary channel stby6 type disk ;
allocate auxiliary channel stby7 type disk ;
allocate auxiliary channel stby8 type disk ;
duplicate target database for standby from active database
spfile
parameter_value_convert 'optimus','prime','OPTIMUS','PRIME'
set db_unique_name='prime'
set db_file_name_convert='+DATASSD/optimus','+DATASSD/prime','+DATASAS/optimus','+DATASAS/prime'
set log_file_name_convert='+FRA/optimus','+FRA/prime','+DATASSD/optimus','+DATASSD/prime','+DATASAS/optimus','+DATASAS/prime'
set control_files='+DATASSD','+FRA'
set instance_number='1'
set remote_listener='prime-scan.takasdom.takasbank.com.tr:3000'
reset local_listener
set log_archive_dest_1='LOCATION=+FRA VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=prime'
set log_archive_dest_2='SERVICE=optimus SYNC AFFIRM NET_TIMEOUT=30 REOPEN=300 DB_UNIQUE_NAME=optimus VALID_FOR=(ALL_LOGFILES,PRIMARY_ROLE)'
set log_archive_dest_3='SERVICE=admrac ASYNC NOAFFIRM NET_TIMEOUT=30 REOPEN=300 DB_UNIQUE_NAME=admrac VALID_FOR=(ALL_LOGFILES,PRIMARY_ROLE)'
set log_archive_dest_state_2='DEFER'
set log_archive_dest_state_3='DEFER';
release channel a1;
release channel a2;
release channel a3;
release channel a4;
release channel a5;
release channel a6;
release channel a7;
release channel a8;
release channel stby1;
release channel stby2;
release channel stby3;
release channel stby4;
release channel stby5;
release channel stby6;
release channel stby7;
release channel stby8;
}

Starting Duplicate Db at 18-FEB-11
using target database control file instead of recovery catalog
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=13 device type=DISK

contents of Memory Script:
{
backup as copy reuse
targetfile '/oracle/product/11.2.0.3/db/dbs/orapwoptimus1' auxiliary format
'/oracle/product/11.2.0.3/db/dbs/orapwprime1'  targetfile
'+DATA/optimus/spfilerac11g2.ora' auxiliary format
'/oracle/product/11.2.0.3/db/dbs/spfileprime1.ora'  ;
sql clone "alter system set spfile=
''/oracle/product/11.2.0.3/db/dbs/spfileprime1.ora''";
}
executing Memory Script

Starting backup at 18-FEB-11
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=155 instance=optimus1 device type=DISK
Finished backup at 18-FEB-11

sql statement: alter system set spfile=''/oracle/product/11.2.0.3/db/dbs/spfileprime1.ora''

contents of Memory Script:
{
sql clone "alter system set audit_file_dest =''/oracle/admin/prime/adump'' comment='''' scope=spfile";
sql clone "alter system set dispatchers =''(PROTOCOL=TCP) (SERVICE=primeXDB)'' comment='''' scope=spfile";
sql clone "alter system set db_unique_name =''prime'' comment='''' scope=spfile";
sql clone "alter system set db_file_name_convert =''+DATA/optimus'', ''+DATA/prime'' comment='''' scope=spfile";
sql clone "alter system set log_file_name_convert =''+FRA/optimus'', ''+FRA/prime'', ''+DATA/optimus'',''+DATA/prime'' comment='''' scope=spfile";
sql clone "alter system set control_files =''+DATA'', ''+FRA'' comment='''' scope=spfile";
sql clone "alter system set instance_number =
1 comment='''' scope=spfile";
sql clone "alter system set log_archive_max_processes =5 comment='''' scope=spfile";
sql clone "alter system set fal_client =''PRIME'' comment='''' scope=spfile";
sql clone "alter system set fal_server =''OPTIMUS1'', ''OPTIMUS2'' comment='''' scope=spfile";
sql clone "alter system set remote_listener =''prime-scan:3000'' comment='''' scope=spfile";
sql clone "alter system set log_archive_dest_2 =''service=OPTIMUS LGWR ASYNC NOAFFIRM max_failure=10 max_connections=5 reopen=180 valid_for=(online_logfiles,primary_role) db_unique_name=optimus'' comment='''' scope=spfile";
sql clone "alter system set log_archive_dest_1 =''location=use_db_recovery_file_dest valid_for=(all_logfiles,all_roles) db_unique_name=prime'' comment='''' scope=spfile";
shutdown clone immediate;
startup clone nomount;
}
executing Memory Script

sql statement: alter system set audit_file_dest =''/oracle/admin/prime/adump'' comment= '''' scope=spfile
sql statement: alter system set dispatchers = ''(PROTOCOL=TCP)(SERVICE=primeXDB)'' comment= '''' scope=spfile
sql statement: alter system set db_unique_name = ''prime'' comment='''' scope=spfile
sql statement: alter system set db_file_name_convert =''+DATA/optimus'', ''+DATA/prime'' comment= '''' scope=spfile
sql statement: alter system set log_file_name_convert =''+FRA/optimus'', ''+FRA/prime'', ''+DATA/optimus'',''+DATA/prime'' comment= '''' scope=spfile
sql statement: alter system set control_files = ''+DATA'',''+FRA'' comment= '''' scope=spfile
sql statement: alter system set instance_number = 1 comment= '''' scope=spfile
sql statement: alter system set log_archive_max_processes = 5 comment= '''' scope=spfile
sql statement: alter system set fal_client = ''PRIME'' comment= '''' scope=spfile
sql statement: alter system set fal_server = ''OPTIMUS1'',''OPTIMUS2'' comment= '''' scope=spfile
sql statement: alter system set remote_listener = ''prime-scan:3000'' comment= '''' scope=spfile
sql statement: alter system set log_archive_dest_2 =''service=OPTIMUS LGWR ASYNC NOAFFIRM max_failure=10 max_connections=5 reopen=180 valid_for=(online_logfiles,primary_role) db_unique_name=optimus'' comment= '''' scope=spfile

sql statement: alter system set log_archive_dest_1 =''location=use_db_recovery_file_dest valid_for=(all_logfiles,all_roles) db_unique_name=prime'' comment= '''' scope=spfile

Oracle instance shut down

connected to auxiliary database (not started)
Oracle instance started

Total System Global Area   630501376 bytes

Fixed Size           2229120 bytes
Variable Size        247467136 bytes
Database Buffers       373293056 bytes
Redo Buffers          7512064 bytes

contents of Memory Script:
{
sql clone "alter system set control_files =
''+DATA/prime/controlfile/current.256.743447505'',
''+FRA/prime/controlfile/current.256.743447507'' comment=
''Set by RMAN'' scope=spfile";
backup as copy current controlfile for standby auxiliary format
'+DATA/prime/controlfile/current.257.743447507';
restore clone controlfile to
'+FRA/prime/controlfile/current.257.743447507' from
'+DATA/prime/controlfile/current.257.743447507';
sql clone "alter system set control_files =
''+DATA/prime/controlfile/current.257.743447507'',
''+FRA/prime/controlfile/current.257.743447507'' comment=
''Set by RMAN'' scope=spfile";
shutdown clone immediate;
startup clone nomount;
}
executing Memory Script

sql statement: alter system set control_files =
''+DATA/prime/controlfile/current.256.743447505'',
''+FRA/prime/controlfile/current.256.743447507'' comment= ''Set by
RMAN'' scope=spfile

Starting backup at 18-FEB-11
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile copy
copying standby control file
output file name=/oracle/product/11.2.0.3/db/dbs/snapcf_optimus1.f
tag=TAG20110218T161053 RECID=1 STAMP=743443854
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:07
Finished backup at 18-FEB-11

Starting restore at 18-FEB-11
allocated channel: ORA_AUX_DISK_1
channel ORA_AUX_DISK_1: SID=19 instance=prime1 device type=DISK

channel ORA_AUX_DISK_1: copied control file copy
Finished restore at 18-FEB-11

sql statement: alter system set control_files =
''+DATA/prime/controlfile/current.257.743447507'',
''+FRA/prime/controlfile/current.257.743447507'' comment= ''Set by
RMAN'' scope=spfile

Oracle instance shut down

connected to auxiliary database (not started)
Oracle instance started

Total System Global Area   630501376 bytes

Fixed Size           2229120 bytes
Variable Size        247467136 bytes
Database Buffers       373293056 bytes
Redo Buffers          7512064 bytes

contents of Memory Script:
{
sql clone 'alter database mount standby database';
}
executing Memory Script

sql statement: alter database mount standby database
RMAN-05529: WARNING: DB_FILE_NAME_CONVERT resulted in invalid ASM
names; names changed to disk group only.

contents of Memory Script:
{
set newname for tempfile 1 to
"+data";
switch clone tempfile all;
set newname for datafile 1 to
"+data";
set newname for datafile 2 to
"+data";
set newname for datafile 3 to
"+data";
set newname for datafile 4 to
"+data";
set newname for datafile 5 to
"+data";
set newname for datafile 6 to
"+data";
set newname for datafile 7 to
"+data";
backup as copy reuse
datafile 1 auxiliary format
"+data"  datafile
2 auxiliary format
"+data"  datafile
3 auxiliary format
"+data"  datafile
4 auxiliary format
"+data"  datafile
5 auxiliary format
"+data"  datafile
6 auxiliary format
"+data"  datafile
7 auxiliary format
"+data"  ;
sql 'alter system archive log current';
}
executing Memory Script

executing command: SET NEWNAME

renamed tempfile 1 to +data in control file

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

executing command: SET NEWNAME

Starting backup at 18-FEB-11
using channel ORA_DISK_1
channel ORA_DISK_1: starting datafile copy
input datafile file number=00002
name=+DATA/optimus/datafile/sysaux.257.740770047
output file name=+DATA/prime/datafile/sysaux.258.743447539
tag=TAG20110218T161124
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00001
name=+DATA/optimus/datafile/system.256.740770045
output file name=+DATA/prime/datafile/system.259.743447625
tag=TAG20110218T161124
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:01:15
channel ORA_DISK_1: starting datafile copy
input datafile file number=00003
name=+DATA/optimus/datafile/undotbs1.258.740770049
output file name=+DATA/prime/datafile/undotbs1.260.743447699
tag=TAG20110218T161124
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:25
channel ORA_DISK_1: starting datafile copy
input datafile file number=00005
name=+DATA/optimus/datafile/undotbs2.264.740770355
output file name=+DATA/prime/datafile/undotbs2.261.743447725
tag=TAG20110218T161124
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:07
channel ORA_DISK_1: starting datafile copy
input datafile file number=00004 name=+DATA/optimus/datafile/users.259.740770049
output file name=+DATA/prime/datafile/users.262.743447733 tag=TAG20110218T161124
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:01
channel ORA_DISK_1: starting datafile copy
input datafile file number=00006 name=+DATA/optimus/datafile/test.268.741633047
output file name=+DATA/prime/datafile/test.263.743447733 tag=TAG20110218T161124
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:01
channel ORA_DISK_1: starting datafile copy
input datafile file number=00007 name=+DATA/optimus/datafile/test.269.741633183
output file name=+DATA/prime/datafile/test.264.743447735 tag=TAG20110218T161124
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:01
Finished backup at 18-FEB-11

sql statement: alter system archive log current

contents of Memory Script:
{
switch clone datafile all;
}
executing Memory Script

datafile 1 switched to datafile copy
input datafile copy RECID=1 STAMP=743447740 file
name=+DATA/prime/datafile/system.259.743447625
datafile 2 switched to datafile copy
input datafile copy RECID=2 STAMP=743447740 file
name=+DATA/prime/datafile/sysaux.258.743447539
datafile 3 switched to datafile copy
input datafile copy RECID=3 STAMP=743447740 file
name=+DATA/prime/datafile/undotbs1.260.743447699
datafile 4 switched to datafile copy
input datafile copy RECID=4 STAMP=743447740 file
name=+DATA/prime/datafile/users.262.743447733
datafile 5 switched to datafile copy
input datafile copy RECID=5 STAMP=743447740 file
name=+DATA/prime/datafile/undotbs2.261.743447725
datafile 6 switched to datafile copy
input datafile copy RECID=6 STAMP=743447740 file
name=+DATA/prime/datafile/test.263.743447733
datafile 7 switched to datafile copy
input datafile copy RECID=7 STAMP=743447740 file
name=+DATA/prime/datafile/test.264.743447735
Finished Duplicate Db at 18-FEB-11
</code></pre>

                    <pi>20. Once the above command suceeds on primary on the standby(orclis1 node) run the log apply command</pi>
                    <pre class="wp-block-code"><code>

SQL> alter database recover managed standby database using current logfile disconnect;
Database altered.
</code></pre>
                    <p>On the database alert log it could be observed archived logs being applied</p>
                    <pre class="wp-block-code"><code>
Fri Feb 18 17:19:56 2011
alter database recover managed standby database using current logfile disconnect
Attempt to start background Managed Standby Recovery process (prime1)
Fri Feb 18 17:19:56 2011
MRP0 started with pid=60, OS id=8639
MRP0: Background Managed Standby Recovery process started (prime1)
started logmerger process
Fri Feb 18 17:20:01 2011
Managed Standby Recovery starting Real Time Apply
Parallel Media Recovery started with 2 slaves
Waiting for all non-current ORLs to be archived...
All non-current ORLs have been archived.
Fri Feb 18 17:20:02 2011
Media Recovery Log
+FRA/prime/archivelog/2011_02_18/thread_1_seq_53.269.743447835
Media Recovery Log
+FRA/prime/archivelog/2011_02_18/thread_2_seq_43.268.743447835
Completed: alter database recover managed standby database using
current logfile disconnect
Media Recovery Log
+FRA/prime/archivelog/2011_02_18/thread_1_seq_54.271.743447847
Media Recovery Log
+FRA/prime/archivelog/2011_02_18/thread_2_seq_44.270.743447847
Media Recovery Log
+FRA/prime/archivelog/2011_02_18/thread_2_seq_45.273.743447887
Media Recovery Log
+FRA/prime/archivelog/2011_02_18/thread_1_seq_55.272.743447883
Media Recovery Waiting for thread 1 sequence 56 (in transit)
Recovery of Online Redo Log: Thread 1 Group 6 Seq 56 Reading mem 0
Mem# 0: +DATA/prime/onlinelog/group_6.270.743447749
Mem# 1: +FRA/prime/onlinelog/group_6.263.743447751
Media Recovery Waiting for thread 2 sequence 46 (in transit)
Recovery of Online Redo Log: Thread 2 Group 9 Seq 46 Reading mem 0
Mem# 0: +DATA/prime/onlinelog/group_9.273.743447755
Mem# 1: +FRA/prime/onlinelog/group_9.266.743447755
</code></pre>
                    <p>Another way to find out is to connect into the standby instance (prime1 running on orclis1 node) and issue</p>
                    <pre class="wp-block-code"><code>
SQL> select sequence#,thread#,applied from v$archived_log;

SEQUENCE# THREAD#       APPLIED
---------- ---------- ---------
53          1           YES
43          2           YES
54          1           YES
44          2           YES
55          1           YES
45          2           IN-MEMORY
6 rows selected.
</code></pre>
                    <p>which shows YES on archive log applied column.</p>
                    <p></p>


                    <pi>21. With above configuration inplace the data guard is setup and working. The next step is to bring the standby database under the control of the cluster. For this on the standby instance create a pfile from the spfile that was created
                        during the duplication process.</pi>
                    <pre class="wp-block-code"><code>
SQL> create pfile='/home/oracle/stdbypfile.ora' from spfile;
                </code></pre>

                    <pi>22. Edit the pfile and remove any references to primary db (optimus) except db_name this must be same as primary db. Set instance specific instance_number, undo_tablespace, fal_client and thread. pfile content after the edit is given
                        below
                    </pi>
                    <pre class="wp-block-code"><code>
prime1.__db_cache_size=373293056
prime1.__java_pool_size=4194304
prime1.__large_pool_size=4194304
prime1.__oracle_base='/opt/app/oracle'#ORACLE_BASE set from environment
prime1.__pga_aggregate_target=209715200
prime1.__sga_target=633339904
prime1.__shared_io_pool_size=0
prime1.__shared_pool_size=239075328
prime1.__streams_pool_size=0
prime2.__db_cache_size=373293056
prime2.__java_pool_size=4194304
prime2.__large_pool_size=4194304
prime2.__oracle_base='/opt/app/oracle'#ORACLE_BASE set from environment
prime2.__pga_aggregate_target=209715200
prime2.__sga_target=633339904
prime2.__shared_io_pool_size=0
prime2.__shared_pool_size=239075328
prime2.__streams_pool_size=0
*.audit_file_dest='/opt/app/oracle/admin/prime/adump'
*.audit_trail='db'
*.cluster_database=true
*.compatible='11.2.0.0.0'
*.control_files='+DATA/prime/controlfile/current.257.743447507','+FRA/prime/controlfile/current.257.743447507'#Set by RMAN
*.db_block_size=8192
*.db_create_file_dest='+DATA'
*.db_domain='domain.net'
*.db_file_name_convert='+DATA/optimus','+DATA/prime'
*.db_name='optimus'
*.db_recovery_file_dest='+FRA'
*.db_recovery_file_dest_size=9470738432
*.db_unique_name='prime'
*.diagnostic_dest='/opt/app/oracle'
*.dispatchers='(PROTOCOL=TCP) (SERVICE=primeXDB)'
prime1.fal_client='RAC11G2S1'
rac1g2s22.fal_client='RAC11G2S2'
*.fal_server='RAC11G21','RAC11G22'
prime1.instance_number=1
prime2.instance_number=2
*.log_archive_config='dg_config=(optimus,prime)'
*.log_archive_dest_2='service=OPTIMUS LGWR ASYNC NOAFFIRM
max_failure=10 max_connections=5 reopen=180
valid_for=(online_logfiles,primary_role) db_unique_name=optimus'
*.log_archive_dest_1='location=use_db_recovery_file_dest
valid_for=(all_logfiles,all_roles) db_unique_name=prime'
*.log_archive_dest_state_2='enable'
*.log_archive_dest_state_1='enable'
*.log_archive_format='%t_%s_%r.dbf'
*.log_archive_max_processes=5
*.log_file_name_convert='+FRA/optimus','+FRA/prime','+DATA/optimus','+DATA/prime'
*.open_cursors=300
*.pga_aggregate_target=209715200
*.processes=150
*.remote_listener='racb-scan:1521'
*.remote_login_passwordfile='exclusive'
*.sga_target=631242752
*.standby_file_management='AUTO'
prime1.undo_tablespace='UNDOTBS1'
prime2.undo_tablespace='UNDOTBS2'
prime1.thread=1
prime2.thread=2
    </code></pre>
                    <p>
                        <u> Insert line which contains "controlfile" row in /home/oracle/stdbypfile.ora to (~/primeinitpfile) ********* PRIME : apply 2. node !!!!!!!!</u>
                    </p>

                    <pi>23. Shutdown the database and startup mount and create a spfile with +ASM diskgroup as the location</pi>
                    <pre class="wp-block-code"><code>
--SQL> alter database recover managed standby database cancel;
SQL> shu immediate;
SQL> startup mount pfile='/home/oracle/stdbypfile.ora';

ORACLE instance started.

Total System Global Area 630501376 bytes
Fixed Size 2229120 bytes
Variable Size  247467136 bytes
Database Buffers 373293056 bytes
Redo Buffers 7512064 bytes
Database mounted.
</code></pre>
                    <p>Before running the following command check the files under +DATASSD/prime/parameterfile folder</p>
                    <pre class="wp-block-code"><code>
[oracle@orclis1 ~]$ asm
[oracle@orclis1 ~]$ asmcmd ls +DATASSD/prime/parameterfile

        in case it doesn't exist 

SQL> create spfile='+DATASSD' from pfile='/home/oracle/stdbypfile.ora';
File created.
[oracle@orclis1 ~]$ asmcmd ls +DATASSD/prime/parameterfile

spfile.287.850861069
</code></pre>
                    <p>The new file created (spfile.287.850861069) will be used as spfile</p>
                    <pre class="wp-block-code"><code>
spfile='+DATASSD/prime/parameterfile/spfile.287.850861069'
SQL> shutdown immediate;
</code></pre>


                    <pi>24. Create pfile file on each node's oracle home ($ORACLE_HOME/dbs) that points to the spfile by adding one line that referes to the spfile</pi>
                    <pre class="wp-block-code"><code>
orclis1:
--------
vi initprime1.ora
spfile='+DATASSD/prime/parameterfile/spfile.287.850861069'

orclis2:
-------
vi initprime2.ora
spfile='+DATASSD/prime/parameterfile/spfile.287.850861069'
spfile='+DATASSD/admrac/parameterfile/spfile.258.833668493'
</code></pre>
                    <p>Above is for orclis1, create initprime2.ora on orclis2.</p>
                    <p></p>

                    <pi>25. Once above pfiles are created remove the spfile in $ORACLE_HOME/dbs that was created as part of the duplication. -->???</pi>

                    <p></p>

                    <pi>26. Before bringing the standby instance under cluster control check it could be started on all other nodes with their respective instances. In this case orclis2 since this is a two node rac, export ORACLE_SID to prime2 and start the
                        instance in mount mode. Resolve any issues (init parameter related) before proceeding to the next step)</pi>

                    <p></p>

                    <pi>27. To add the database and instances to the cluster configuration run (not needed if there was already a cluster and you're just resyncronizing it)</pi>
                    <pre class="wp-block-code"><code>
$ srvctl add database -d prime -o $ORACLE_HOME -m local -p "+DATASSD/prime/parameterfile/spfile.287.850861069" -n optimus -r physical_standby -s mount
$ srvctl add instance -d prime -i prime1 -n orclis1
$ srvctl add instance -d prime -i prime2 -n orclis2
</code></pre>
                    <p>Without the "-s mount" the standby database would be started in open (read only) mode by default (both R1 and R2). With 11g (both R1 and R2) it is possible to apply redo while the database is open in read only mode. But this requires
                        active dataguard license and setting the default startup mode to mount prevents such activity from happenning when active dataguard is not licensed. On 11gR1 db instances could be made dependent on that node's asm instance but
                        this option is deprecated in 11gr2</p>

                    <p>$CRS_HOME/bin/srvctl modify instance -d prime -i prime1 -s +ASM1 -s option has been deprecated and will be ignored.</p>
                    <pre class="wp-block-code"><code>
$ srvctl config database -d prime

Database unique name: prime
Database name: optimus
Oracle home: /oracle/product/11.2.0.3/db
Oracle user: oracle
Spfile: +DATASSD/prime/parameterfile/spfile.274.824598353
Domain:
Start options: mount
Stop options: immediate
Database role: PHYSICAL_STANDBY
Management policy: AUTOMATIC
Server pools: prime
Database instances: prime1,prime2
Disk Groups: DATASAS,DATASSD,FRA
Mount point paths:
Services: optimus
Type: RAC
Database is administrator managed
</code></pre>

                    <pi>28. Test the configuration with starting the entire standby database</pi>
                    <pre class="wp-block-code"><code>
$ srvctl status database -d prime

Instance prime1 is not running on node orclis1
Instance prime2 is not running on node orclis2

$ srvctl modify database -d prime -p +DATASSD/prime/parameterfile/spfile.287.850861069

srvctl config database -d prime
srvctl start database -d prime

$ srvctl status database -d prime

Instance prime1 is running on node orclis1
Instance prime2 is running on node orclis2
                </code></pre>
                    <p>Once the database is started as a cluster resource the asm dependencies are automatically added as well as the local_listener values which were reset during the duplication.</p>
                    <p></p>
                    <p>crsctl stat res ora.prime.db -p</p>
                    <p></p>
                    <p>NAME=ora.prime.db</p>
                    <p>TYPE=ora.database.type</p>
                    <p>..</p>
                    <p>SERVER_POOLS=ora.prime</p>
                    <p>SPFILE=+DATA/prime/spfileprime.ora</p>
                    <p>START_DEPENDENCIES=hard(ora.DATA.dg,ora.FRA.dg)weak(type:ora.listener.type,global:type:ora.scan_listener.type,uniform:ora.ons,global:ora.gns)pullup(ora.DATA.dg,ora.FRA.dg)</p>
                    <p>START_TIMEOUT=600</p>
                    <p>STATE_CHANGE_TEMPLATE=</p>
                    <p>STOP_DEPENDENCIES=hard(intermediate:ora.asm,shutdown:ora.DATA.dg,shutdown:ora.FRA.dg)</p>
                    <p>..</p>
                    <pre class="wp-block-code"><code>
SQL>  show parameter local

NAME            TYPE        VALUE
--------------- ---------- ------------------------------
local_listener  string     (DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP(HOST=172.30.33.51)(PORT=3000))))
                    </code></pre>
                    <p></p>

                    <pi>29. Start the recovery process on one of the standby instances.</pi>
                    <pre class="wp-block-code"><code>
SQL>  alter database recover managed standby database using current logfile disconnect;

$ srvctl add service -d prime -s optimus -r prime1,prime2

        To validate ReadOnly Mode transition :

SQL> alter database recover managed standby database cancel; --apply stopped..

SQL> alter database open; (on both nodes)

SQL> alter database recover managed standby database disconnect;
</code></pre>
                    <p>To validate the setup run below query on both ends (Primary-Standby)</p>
                    <pre class="wp-block-code"><code>
SQL>  select max(sequence#),thread# from v$log_history group by thread#;
</code></pre>

                    <p>This concludes the setup of RAC-RAC data guard.</p>
                    <p></p>

                    <pi>30. To make sure archive logs don't get deleted on primary without being applied on standby set the log deletion policy to applied on standby. For this at least one log archive locations must be mandatory.</pi>

                    <p>SQL> alter system set log_archive_dest_2='service=PRIME LGWR ASYNC NOAFFIRM max_failure=10 max_connections=5 reopen=180 valid_for=(online_logfiles,primary_role) db_unique_name=prime mandatory' scope=both sid='*';</p>
                    <p></p>
                    <p>Usign rman change the archive log deletion policy.</p>
                    <p></p>
                    <p>RMAN&gt; CONFIGURE ARCHIVELOG DELETION POLICY TO APPLIED ON STANDBY;</p>
                    <p></p>
                    <p>old RMAN configuration parameters:</p>
                    <p></p>
                    <p>CONFIGURE ARCHIVELOG DELETION POLICY TO NONE;</p>
                    <p>new RMAN configuration parameters:</p>
                    <p>CONFIGURE ARCHIVELOG DELETION POLICY TO APPLIED ON STANDBY;</p>
                    <p></p>
                    <p>new RMAN configuration parameters are successfully stored</p>
                    <p></p>
                    <p>If it is configured APPLIED ON ALL STANDBY then archived redo log files are eligible for deletion after being applied or consumed on all remote destinations, whether mandatory or not.</p>
                    <p></p>
                    <p>With mandatory destination inplace if the standby is not up and accepting redo when the primary starts following error</p>
                    <p></p>
                    <p>PING[ARC1]: Heartbeat failed to connect to standby 'PRIME'. Error is 12543.</p>
                    <p>Archived Log entry 202 added for thread 1 sequence 80 ID 0x16a13366 dest 10:</p>
                    <p>ARCH: Archival stopped, error occurred. Will continue retrying</p>
                    <p>ORACLE Instance optimus1 - Archival Error</p>
                    <p>ORA-16038: log 2 sequence# 80 cannot be archived</p>
                    <p>ORA-12543: TNS:destination host unreachable</p>
                    <p>ORA-00312: online log 2 thread 1:</p>
                    <p>'+DATA/optimus/onlinelog/group_2.262.740770163'</p>
                    <p>ORA-00312: online log 2 thread 1:</p>
                    <p>'+FRA/optimus/onlinelog/group_2.258.740770163'</p>
                    <p></p>
                    <p>and any alter system switch logfile commands will hang.</p>
                    <p></p>
                    <p>Distributing redo load</p>
                    <p></p>
                    <p>It is possible to distribute the redo load among all standby instnaces. In this case instead of sending the redo from all primary instance to one standby instance each primary instance will send its redo to corresponding standby instance.
                        This configuration is ideal in a symmetric data guard environment and one signle standby instance cannot keep up with all the redo generated. To do this set primary instance specific log_archive_dest values</p>
                    <p></p>
                    <p>alter system set log_archive_dest_2='service=prime1 LGWR ASYNC NOAFFIRM max_failure=10 max_connections=5 reopen=180 valid_for=(online_logfiles,primary_role) db_unique_name=prime mandatory' scope=spfile sid='optimus1';</p>
                    <p></p>
                    <p>alter system set log_archive_dest_2='service=prime2 LGWR ASYNC NOAFFIRM max_failure=10 max_connections=5 reopen=180 valid_for=(online_logfiles,primary_role) db_unique_name=prime mandatory' scope=spfile sid='optimus2';</p>
                    <p></p>
                    <p>Here optimus1 will send its redo to prime1 and optimus2 will send to prime2.</p>
                    <p></p>
                    <p>But there can only be one apply instance.</p>
                    <p></p>
                    <p>Otherway around, sending all primary redo once standby instance gives more flexibility than above one-to-one redo transport configuration.</p>
                    <p>In this case if the current standby apply instance need to be shutdown all that is required is stop the apply service on that instance and</p>
                    <p>start in another instance. Since there's no instance specific redo transport configuration no additional steps are required. (provided the TNS entry has addressed for all standby instances similar to prime TNS entry above).</p>
                    <p></p>
                    <p>Related Post</p>
                    <p>11gR2 Standalone Data Guard (with ASM and Role Separation)</p>
                    <p>Data Guard Broker for 11gR2 RAC</p>
                    <p>Enable Active Dataguard on 11gR2 RAC Standby</p>
                </div>
            </div>
        </section>

        <!-- -----------x---------- Site Content -------------x------------>

    </main>

    <!---------------x------------- Main Site Section ---------------x-------------->


    <!-- --------------------------- Footer ---------------------------------------- -->

    <footer class="footer">
        <div class="container">
            <div class="about-us" data-aos="fade-right" data-aos-delay="200">
                <h2>Sentinity</h2>
                <p>.</p>
            </div>
            <div class="newsletter" data-aos="fade-right" data-aos-delay="200">
                <h2>Newsletter</h2>
                <p>Stay update with our latest</p>
                <div class="form-element">
                    <input type="text" placeholder="Email"><span><i class="fas fa-chevron-right"></i></span>
                </div>
            </div>

            <div class="follow" data-aos="fade-left" data-aos-delay="200">
                <h2>Follow us</h2>
                <p>Let us be Social</p>
                <div>
                    <i class="fab fa-facebook-f"></i>
                    <i class="fab fa-twitter"></i>
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-youtube"></i>
                </div>
            </div>
        </div>
        <div class="rights flex-row">
            <h4 class="text-gray">
                Copyright 2021 All rights reserved | made by Sentinity
            </h4>
        </div>
        <div class="move-up">
            <span><i class="fas fa-arrow-circle-up fa-2x"></i></span>
        </div>
    </footer>

    <!-- -------------x------------- Footer --------------------x------------------- -->

    <!-- Jquery Library file -->
    <script src="../../js/Jquery3.4.1.min.js"></script>

    <!-- --------- Owl-Carousel js ------------------->
    <script src="../../js/owl.carousel.min.js"></script>

    <!-- ------------ AOS js Library  ------------------------- -->
    <script src="../../js/aos.js"></script>

    <!-- Custom Javascript file -->
    <script src="../../js/main.js"></script>
</body>

</html>